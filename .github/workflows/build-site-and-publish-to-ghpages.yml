# For more information see: https://github.com/marketplace/actions/deploy-to-github-pages

name: Build Site and Deploy to Github Pages
on:
  push:
    branches:
      - main

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

# Default to bash
defaults:
  run:
    shell: bash

jobs:
    build-and-deploy:
      concurrency: ci-${{ github.ref }} # Recommended if you intend to make multiple deployments in quick succession.
      runs-on: ubuntu-latest
      steps:
        - name: Checkout üõéÔ∏è
          uses: actions/checkout@v3
          with:
            submodules: recursive

        - name: Setup pnpm
          uses: pnpm/action-setup@v2.2.4
        # with:
        #   version: 8.5.1
        #   dest: ./internal_website
        #   run_install: |
        #     - recursive: false
        #     - cwd: ./internal_website

        - name: Use Node.js
          uses: actions/setup-node@v3
          with:
            node-version: 'latest'
            cache: 'pnpm'

        - name: Setup Protocol Buffer Compiler
          uses: arduino/setup-protoc@v2

        - name: Setup Python
          uses: actions/setup-python@v4
          with:
            python-version: '3.10'
            cache: 'pip' # caching pip dependencies

        - name: Install Betterproto
          run: pip install "betterproto[compiler]"

        # - name: Install Cython
        #   run: pip install Cython

        - name: Install and Build üîß # This project is built using pnpm and outputs the result to the 'dist' folder. Replace with the commands required to build your project, or remove this step entirely if your site is pre-built.
          run: |
            pnpm install
            pnpm run compile:proto
            pnpm run build

        - name: Zip Repo to share as a Github Release
          uses: thedoctor0/zip-release@0.7.1
          with:
            type: 'zip'
            filename: 'project.zip'
            exclusions: '/*node_modules/* .editorconfig *.git*'

        - name: Upload Release
          uses: ncipollo/release-action@v1.12.0
          with:
            artifacts: "project.zip"
            tag: AutoRelease_${{ github.sha }}
            commit: ${{ github.sha }}
            token: ${{ secrets.GITHUB_TOKEN }}
            makeLatest: true
            allowUpdates: true

        - name: Deploy Site to Github Pages Website Hosting üöÄ
          uses: JamesIves/github-pages-deploy-action@v4.3.4
          with:
            folder: dist # The folder the action should deploy.
