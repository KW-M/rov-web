var f=Object.defineProperty;var k=(e,o,t)=>o in e?f(e,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[o]=t;var r=(e,o,t)=>(k(e,typeof o!="symbol"?o+"":o,t),t);import{r as u,s as I,a as E,P as p,L as y,D as R,c as b,E as g}from"./proxy-9225cf57.js";import{R as L,D as N,a as s,b as a,P as d,M as O,T as D,g as M,c as P,w}from"./livekit-client.esm-c197ff19.js";window.LIVEKIT_TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ2aWRlbyI6eyJyb29tTGlzdCI6dHJ1ZSwicm9vbUpvaW4iOmZhbHNlLCJjYW5QdWJsaXNoIjpmYWxzZSwiY2FuU3Vic2NyaWJlIjpmYWxzZSwiY2FuUHVibGlzaERhdGEiOmZhbHNlfSwiaWF0IjoxNjc4NzI4ODY1LCJuYmYiOjE2Nzg3Mjg4NjUsImV4cCI6MTExMzk1Mjg4NjUsImlzcyI6IkFQSWtvRTdtM1pxZDVkSiIsInN1YiI6Imx0IiwianRpIjoibHQifQ.6mVaD452mZMSgXKWG7QDkxR__2v76urjJnJ66TjJGjs";function T(e){u(e)}function U(){window.parent?(I(e=>{console.log("postMessage",e),window.parent.postMessage(e,"*")}),window.addEventListener("message",e=>{console.log("Got iframe parent message",e),u(e.data)})):console.warn("enableFrameProxy() called without this page being inside an iframe")}async function C(e){return await fetch(e+"/twirp/livekit.RoomService/ListRooms",{method:"POST",cache:"no-cache",mode:"cors",body:JSON.stringify({}),headers:{"Content-Type":"application/json",Authorization:"Bearer "+window.LIVEKIT_TOKEN}}).then(o=>o.json()).then(o=>{const t=o.rooms;if(!t||!Array.isArray(t))throw new Error(`Error getting livekit room list from ${e} - ${JSON.stringify(o)}`);return t.filter(c=>c.num_participants>0)}).catch(o=>(console.warn(`Error getting livekit room list from  - ${e}`,o),[]))}class v{constructor(o,t,c){r(this,"roomId");r(this,"hostUrl");r(this,"accessToken");r(this,"roomConn");r(this,"videoElem");r(this,"onMesssageRecived");r(this,"onConnStateChange");this.hostUrl=o,this.onMesssageRecived=n=>t(n,this.roomId,this.hostUrl),this.onConnStateChange=n=>c(n,this.roomId,this.hostUrl),this.roomConn=new L({reconnectPolicy:new N,adaptiveStream:!0})}async start(o,t){console.log(`Starting conn with ${o} via ${this.hostUrl} token = ${t}`);const c=Date.now();return this.roomId=o,this.roomConn.on(s.SignalConnected,async()=>{const n=Date.now()-c;a(`signal connection established in ${n}ms`)}).on(s.Connected,async()=>{a(`Connected to room: ${this.roomConn.name} via ${this.hostUrl}`)}).on(s.Disconnected,n=>{this.roomConn&&(a("disconnected from room",{reason:n},this.roomConn.localParticipant),this.roomConn.participants.forEach(i=>{}))}).on(s.Reconnecting,()=>{a("Reconnecting to room")}).on(s.Reconnected,async()=>{a("Successfully reconnected. server",await this.roomConn.engine.getConnectedServerAddress())}).on(s.ParticipantConnected,async n=>{a("participant",n.identity,"connected",n.metadata),n.on(d.TrackMuted,i=>{a("track was muted",i.trackSid,n.identity)}).on(d.TrackUnmuted,i=>{a("track was unmuted",i.trackSid,n.identity)}).on(d.IsSpeakingChanged,()=>{a("ParticipantEvent.IsSpeakingChanged",n.isSpeaking)}).on(d.ConnectionQualityChanged,()=>{a("ParticipantEvent.ConnectionQualityChanged",n.connectionQuality)})}).on(s.ParticipantDisconnected,n=>{a("participant",n.sid,"disconnected")}).on(s.MediaDevicesError,n=>{const i=O.getFailure(n);a("media device failure",i)}).on(s.ConnectionQualityChanged,(n,i)=>{a("connection quality changed",i==null?void 0:i.identity,n)}).on(s.TrackSubscribed,(n,i,l)=>{n.kind===D.Kind.Video&&(this.videoElem=n.attach(),this.videoElem.setAttribute("host",this.hostUrl),document.getElementById("video_container"),document.body.appendChild(this.videoElem)),console.log(n,this.hostUrl)}).on(s.TrackUnsubscribed,(n,i,l)=>{n.detach()}).on(s.DataReceived,async(n,i)=>{const l=i?i.identity:"SERVER";a(`Got dataReceived from ${l} via ${this.hostUrl}|${this.roomId}`,R(n)),this.onMesssageRecived(n,this.roomId,this.hostUrl)}).on(s.LocalTrackUnpublished,(n,i)=>{console.error("handleLocalTrackUnpublished: _THIS SHOULD NEVER BE HAPPENING_",n,i)}).on(s.RoomMetadataChanged,n=>{a("new metadata for room",n)}).on(s.MediaDevicesChanged,()=>{a("MediaDevicesChanged _THIS SHOULDN'T HAPPEN?_")}).on(s.AudioPlaybackStatusChanged,()=>{a("AudioPlaybackStatusChanged _THIS SHOULDN'T HAPPEN?_",this.roomConn.canPlaybackAudio)}),await this.roomConn.connect(M(this.hostUrl),t,b),console.info("connected to room",this.roomConn.name,this.roomConn),!0}sendMessage(o,t,c=!1){console.log("sendMessage() to rov ",this.roomConn.getParticipantByIdentity(this.roomId)),this.roomConn.localParticipant.publishData(o,P.RELIABLE)}close(){console.info("Closing Livekit Connection: ",this.roomId,this.hostUrl),this.roomConn&&this.roomConn.disconnect(!0)}}const m=new v(E,(e,o,t)=>{T(e)},(e,o,t)=>{console.log("Cloud Conn State Changed: "+e,o,t)}),S=new v(p+y,(e,o,t)=>{T(e)},(e,o,t)=>{console.log("Local Conn State Changed: "+e,o,t)});async function _(e,o){await m.start(e,o)}async function H(e,o){!window.parent||window.parent===window.top?I(t=>{console.log("send proxy message: "+t.byteLength),m.sendMessage(new Uint8Array(t))}):U(),await w(100),await S.start(e,o)}async function j(){S.sendMessage(g("HI FROM FRONTEND SHOULD BE LOCAL")),m.sendMessage(g("HI FROM FRONTEND SHOULD BE CLOUD"))}new URLSearchParams(location.search);const h=document.getElementById("rov_chooser");document.getElementById("video_container");async function F(){console.log("Starting...");const e=document.createElement("button");for(e.innerText="Send test msg",e.disabled=!0,e.onclick=()=>{j()},document.body.appendChild(e);;){const o=await C(E);await C(y);const t=o;t.length>0?(h.innerHTML="",t.forEach(c=>{if(!c.metadata)return;const n=document.createElement("button"),{accessToken:i}=JSON.parse(c.metadata);n.innerText="Connect to "+c.name,n.onclick=()=>{_(c.name,i).then(()=>{e.disabled=!1,n.innerText="Connect locally to "+c.name,n.onclick=()=>{H(c.name,i).then(()=>{})}})},h.appendChild(n)})):h.innerHTML="Searching...",await w(1e3);break}}F();
//# sourceMappingURL=frontend-67f9ed9c.js.map
