{"version":3,"file":"proxyReciever-e68a371e.js","sources":["../../js/proxyReciever.ts"],"sourcesContent":["import { proxyInterchangeFormat, proxyMessageTypes } from \"../frontend/js/proxy\";\nimport { DECODE_TXT, ENCODE_TXT } from \"./consts\";\n\nconst openHttpConnections: { [key: string]: Promise<Response> } = {}\nconst openWebsocketConnections: { [key: string]: WebSocket } = {}\n\nlet sendProxyMessageCallback: (rawMsg: ArrayBufferLike) => void;\nexport function setSendProxyMessageCallback(callback: (data: ArrayBufferLike) => void) {\n    sendProxyMessageCallback = callback;\n}\n\nfunction openWebsocket(url: string) {\n    if (openWebsocketConnections[url]) return openWebsocketConnections[url];\n    const ws = openWebsocketConnections[url] = new WebSocket(url);\n    ws.binaryType = \"arraybuffer\";\n    ws.addEventListener('message', (ev) => {\n        let data = typeof ev.data === typeof '' ? ENCODE_TXT(ev.data) : ev.data;\n        const binary = new Uint8Array(data)\n        if (sendProxyMessageCallback) sendProxyMessageCallback(ENCODE_TXT(JSON.stringify({\n            type: proxyMessageTypes.socketMsg,\n            body: new Array(...binary),\n            url: url,\n        } as proxyInterchangeFormat)))\n    })\n    ws.addEventListener('error', (ev) => {\n        console.warn('ws err ' + url, ev)\n    })\n    ws.addEventListener('close', (ev) => {\n        console.warn('ws close ' + url, ev)\n    })\n    return ws;\n}\n\nfunction sendWebsocketMsg(url: string, data: ArrayBufferLike) {\n    let ws = openWebsocketConnections[url];\n    if (!ws) ws = openWebsocket(url)\n    if (ws.readyState !== WebSocket.OPEN) {\n        console.log(\"osending\", DECODE_TXT(data), ws.readyState, WebSocket.OPEN)\n        ws.addEventListener('open', () => ws.send(data))\n    } else {\n        console.log(\"sending\")\n        ws.send(data);\n    }\n}\n\nfunction sendHttpRequest(url: string, fetchOptions: object) {\n    if (openHttpConnections[url] != undefined) return;\n    const f = openHttpConnections[url] = fetch(url, fetchOptions);\n    f.then(async (result) => {\n        console.log(\"fetch result\", result)\n        let body = new Uint8Array(await result.arrayBuffer())\n        if (sendProxyMessageCallback) sendProxyMessageCallback(ENCODE_TXT(JSON.stringify({\n            type: proxyMessageTypes.outgoingHttpReq,\n            result: result,\n            body: new Array(...body),\n            url: url,\n        } as proxyInterchangeFormat)))\n    }).catch((err) => {\n        console.log(\"fetch err\", err)\n    });\n}\n\nexport function receiveProxiedMsg(rawMsg: ArrayBufferLike) {\n    const proxiedMsg = JSON.parse(DECODE_TXT(rawMsg)) as proxyInterchangeFormat;\n    console.log(\"Received Proxy Message\", proxiedMsg)\n    if (proxiedMsg.type === proxyMessageTypes.openWebsocket) {\n        openWebsocket(proxiedMsg.url)\n    } else if (proxiedMsg.type === proxyMessageTypes.socketMsg) {\n        sendWebsocketMsg(proxiedMsg.url, new Uint8Array(proxiedMsg.body))\n    } else if (proxiedMsg.type === proxyMessageTypes.incomingHttpReq) {\n        sendHttpRequest(proxiedMsg.url, JSON.parse(DECODE_TXT(new Uint8Array(proxiedMsg.body))))\n    }\n}\n"],"names":["openHttpConnections","openWebsocketConnections","sendProxyMessageCallback","setSendProxyMessageCallback","callback","openWebsocket","url","ws","ev","data","ENCODE_TXT","binary","proxyMessageTypes","sendWebsocketMsg","DECODE_TXT","sendHttpRequest","fetchOptions","result","body","err","receiveProxiedMsg","rawMsg","proxiedMsg"],"mappings":"sDAGA,MAAMA,EAA4D,CAAA,EAC5DC,EAAyD,CAAA,EAE/D,IAAIC,EACG,SAASC,EAA4BC,EAA2C,CACxDF,EAAAE,CAC/B,CAEA,SAASC,EAAcC,EAAa,CAChC,GAAIL,EAAyBK,CAAG,EAAG,OAAOL,EAAyBK,CAAG,EACtE,MAAMC,EAAKN,EAAyBK,CAAG,EAAI,IAAI,UAAUA,CAAG,EAC5D,OAAAC,EAAG,WAAa,cACbA,EAAA,iBAAiB,UAAYC,GAAO,CAC/B,IAAAC,EAAO,OAAOD,EAAG,MAAS,SAAYE,EAAWF,EAAG,IAAI,EAAIA,EAAG,KAC7D,MAAAG,EAAS,IAAI,WAAWF,CAAI,EAC9BP,GAAmDA,EAAAQ,EAAW,KAAK,UAAU,CAC7E,KAAME,EAAkB,UACxB,KAAM,IAAI,MAAM,GAAGD,CAAM,EACzB,IAAAL,CACuB,CAAA,CAAC,CAAC,CAAA,CAChC,EACEC,EAAA,iBAAiB,QAAUC,GAAO,CACzB,QAAA,KAAK,UAAYF,EAAKE,CAAE,CAAA,CACnC,EACED,EAAA,iBAAiB,QAAUC,GAAO,CACzB,QAAA,KAAK,YAAcF,EAAKE,CAAE,CAAA,CACrC,EACMD,CACX,CAEA,SAASM,EAAiBP,EAAaG,EAAuB,CACtD,IAAAF,EAAKN,EAAyBK,CAAG,EAChCC,IAAIA,EAAKF,EAAcC,CAAG,GAC3BC,EAAG,aAAe,UAAU,MACpB,QAAA,IAAI,WAAYO,EAAWL,CAAI,EAAGF,EAAG,WAAY,UAAU,IAAI,EACvEA,EAAG,iBAAiB,OAAQ,IAAMA,EAAG,KAAKE,CAAI,CAAC,IAE/C,QAAQ,IAAI,SAAS,EACrBF,EAAG,KAAKE,CAAI,EAEpB,CAEA,SAASM,EAAgBT,EAAaU,EAAsB,CACpD,GAAAhB,EAAoBM,CAAG,GAAK,KAAW,QACjCN,EAAoBM,CAAG,EAAI,MAAMA,EAAKU,CAAY,GAC1D,KAAK,MAAOC,GAAW,CACb,QAAA,IAAI,eAAgBA,CAAM,EAClC,IAAIC,EAAO,IAAI,WAAW,MAAMD,EAAO,YAAa,CAAA,EAChDf,GAAmDA,EAAAQ,EAAW,KAAK,UAAU,CAC7E,KAAME,EAAkB,gBACxB,OAAAK,EACA,KAAM,IAAI,MAAM,GAAGC,CAAI,EACvB,IAAAZ,CACuB,CAAA,CAAC,CAAC,CAAA,CAChC,EAAE,MAAOa,GAAQ,CACN,QAAA,IAAI,YAAaA,CAAG,CAAA,CAC/B,CACL,CAEO,SAASC,EAAkBC,EAAyB,CACvD,MAAMC,EAAa,KAAK,MAAMR,EAAWO,CAAM,CAAC,EACxC,QAAA,IAAI,yBAA0BC,CAAU,EAC5CA,EAAW,OAASV,EAAkB,cACtCP,EAAciB,EAAW,GAAG,EACrBA,EAAW,OAASV,EAAkB,UAC7CC,EAAiBS,EAAW,IAAK,IAAI,WAAWA,EAAW,IAAI,CAAC,EACzDA,EAAW,OAASV,EAAkB,iBAC7BG,EAAAO,EAAW,IAAK,KAAK,MAAMR,EAAW,IAAI,WAAWQ,EAAW,IAAI,CAAC,CAAC,CAAC,CAE/F"}