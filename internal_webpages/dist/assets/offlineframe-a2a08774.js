import{P as w,D as b,E as y}from"./consts-87a546d8.js";const E=e=>({...e,bubbles:e.bubbles||!1,cancelBubble:e.cancelBubble||!1,cancelable:e.cancelable||!1,currentTarget:e.currentTarget||null,data:e.data,defaultPrevented:e.defaultPrevented||!1,eventPhase:e.eventPhase||0,lastEventId:e.lastEventId||"",origin:e.origin||"",path:e.path||new Array(0),ports:e.parts||new Array(0),returnValue:e.returnValue||!0,source:e.source||null,srcElement:e.srcElement||null,target:e.target||null,timeStamp:e.timeStamp||-1,type:e.type||"message",initMessageEvent:e.initMessageEvent||null,__proto__:e.__proto__}),o={triggerOnOpen:(e,n)=>{n=n||new Event("open",{composed:!1,bubbles:!1,cancelable:!1}),e._readyState=1,e._onopen&&e._onopen(n)},triggerOnError:(e,n)=>{n=n||new Event("error",{composed:!1,bubbles:!1,cancelable:!1}),e._readyState=3,e._onerror&&e._onerror(n)},triggerOnClose:(e,n)=>{n=n||new CloseEvent("close",{wasClean:!0,reason:"wsHook",composed:!1,bubbles:!1,cancelable:!1,code:1006}),e._readyState=3,e._onclose&&e._onclose(n)},triggerOnMessage:(e,n)=>{typeof n=="string"||n instanceof ArrayBuffer||(n=n.buffer),console.log("triggerOnMessage",n,e);const r=new MessageEvent("mesage",{data:n,origin:e.url,bubbles:!1,cancelable:!1,composed:!1});e._onmessage&&e._onmessage(r)},allowNewSocket:e=>!0,modifyUrl:e=>e,afterInit:e=>e,beforeOpen:(e,n,r)=>e,beforeError:(e,n,r)=>e,beforeClose:(e,n,r)=>e,beforeSend:(e,n,r)=>e,afterRecive:(e,n,r)=>e,resetHooks:()=>{}};(function(){const e=Object.assign({},o);o.resetHooks=function(){Object.assign(o,e)};var n=WebSocket;WebSocket=Object.assign(function(r,u){const f=o.allowNewSocket(r.toString());r=o.modifyUrl(r)||r;let t;f?(t=u?new n(r,u):new n(r),t.isReal=!0):(t=Object.assign({},n),Object.defineProperty(t,"url",{get(){return r}}),Object.defineProperty(t,"protocols",{get(){return u}}),Object.defineProperty(t,"readyState",{get(){return this._readyState}}),Object.defineProperty(t,"close",{value:()=>o.triggerOnClose(this)}),Object.defineProperty(t,"isReal",{value:!1}),Object.defineProperty(t,"_readyState",{value:0,writable:!0}));var O=t.send;return t.send=function(l){console.log("hook send"),arguments[0]=o.beforeSend(l,t.url,this)||null,arguments[0]!=null&&O.apply(this,arguments)},t._onopen=void 0,t._onerror=void 0,t._addEventListener=t.addEventListener||function(){},t.addEventListener=function(){var i;const l=this,s=arguments[0],a=arguments[1];return s==="message"?(t._onmessage=a,arguments[1]=function(c){return function(){arguments[0]=o.afterRecive(E(arguments[0]),t.url,t),arguments[0]!==null&&c.apply(l,arguments)}}(a)):s==="open"?(t._onopen=a,arguments[1]=function(c){return function(){arguments[0]=o.beforeOpen(arguments[0],t.url,t),arguments[0]!==null&&c.apply(l,arguments)}}(a)):s==="error"?(t._onerror=a,arguments[1]=function(c){return function(){arguments[0]=o.beforeError(arguments[0],t.url,t),arguments[0]!==null&&c.apply(l,arguments)}}(a)):s==="close"&&(t._onclose=a,arguments[1]=function(c){return function(){arguments[0]=o.beforeClose(arguments[0],t.url,t),arguments[0]!==null&&c.apply(l,arguments)}}(a)),(i=t._addEventListener)==null?void 0:i.apply(this,arguments)},Object.defineProperty(t,"onmessage",{set:function(){var i;var l=this,s=arguments[0];t._onmessage=s;var a=s?function(){t.isReal||console.log("onMessageHandler",arguments),arguments[0]=o.afterRecive(E(arguments[0]),t.url,t),arguments[0]!==null&&s.apply(l,arguments)}:null;console.log("onMsgHandler",arguments),(i=t._addEventListener)==null||i.apply(this,["message",a,!1])}}),Object.defineProperty(t,"onopen",{set:function(){var i;var l=this,s=arguments[0];t._onopen=s;var a=s?function(){t.isReal||console.log("onOpenHandler",arguments),arguments[0]=o.beforeOpen(arguments[0],t.url,t),arguments[0]!==null&&s.apply(l,arguments)}:null;console.log("onOpenHandler",arguments),(i=t._addEventListener)==null||i.apply(this,["open",a,!1])}}),Object.defineProperty(t,"onerror",{set:function(){var i;var l=this,s=arguments[0];t._onerror=s;var a=s?function(){t.isReal||console.log("onErrorHandler",arguments),arguments[0]=o.beforeError(arguments[0],t.url,t),arguments[0]!==null&&s.apply(l,arguments)}:null;(i=t._addEventListener)==null||i.apply(this,["error",a,!1])}}),Object.defineProperty(t,"onclose",{set:function(){var i;var l=this,s=arguments[0];t._onclose=s;var a=s?function(){t.isReal||console.log("onCloseHandler",arguments),arguments[0]=o.beforeClose(arguments[0],t.url,t),arguments[0]!==null&&s.apply(l,arguments)}:null;(i=t._addEventListener)==null||i.apply(this,["close",a,!1])}}),o.afterInit(t),t._readyState=n.OPEN,t},n)})();var g=(e=>(e[e.openWebsocket=0]="openWebsocket",e[e.socketMsg=1]="socketMsg",e[e.outgoingHttpReq=2]="outgoingHttpReq",e[e.incomingHttpReq=3]="incomingHttpReq",e))(g||{});let k=!0;const S=e=>e.startsWith(w)||!k;o.allowNewSocket=e=>(console.log("Checking ws url: ",e),S(e)?(console.log("Proxying ws url: ",e),!1):!0);o.modifyUrl=e=>(e=e.toString(),S(e)&&(e=e.substring(w.length)),console.log("modifyUrl: ",e),e);o.afterInit=e=>{const n=e.url;return e.isReal||setTimeout(()=>{o.triggerOnOpen(e),P(n)},1),e};o.beforeSend=(e,n,r)=>r.isReal?e:(console.log("beforeSend: ",r.isReal,r.url,e),H(n,new Uint8Array(e)),null);function P(e){console.log("Sending openWebsocket msg Thru Proxy",{type:0,url:e})}function H(e,n){const r=new Uint8Array(n),u={type:1,url:e,body:new Array(...r)};console.log("Sending Data Thru Proxy",u)}const h={},m={};let d;function R(e){d=e}function v(e){if(m[e])return m[e];const n=m[e]=new WebSocket(e);return n.binaryType="arraybuffer",n.addEventListener("message",r=>{let u=typeof r.data=="string"?y(r.data):r.data;const f=new Uint8Array(u);d&&d(y(JSON.stringify({type:g.socketMsg,body:new Array(...f),url:e})))}),n.addEventListener("error",r=>{console.warn("ws err "+e,r)}),n.addEventListener("close",r=>{console.warn("ws close "+e,r)}),n}function M(e,n){let r=m[e];r||(r=v(e)),r.readyState!==WebSocket.OPEN?(console.log("osending",b(n),r.readyState,WebSocket.OPEN),r.addEventListener("open",()=>r.send(n))):(console.log("sending"),r.send(n))}function C(e,n){if(h[e]!=null)return;(h[e]=fetch(e,n)).then(async u=>{console.log("fetch result",u);let f=new Uint8Array(await u.arrayBuffer());d&&d(y(JSON.stringify({type:g.outgoingHttpReq,result:u,body:new Array(...f),url:e})))}).catch(u=>{console.log("fetch err",u)})}function W(e){const n=JSON.parse(b(e));console.log("Received Proxy Message",n),n.type===g.openWebsocket?v(n.url):n.type===g.socketMsg?M(n.url,new Uint8Array(n.body)):n.type===g.incomingHttpReq&&C(n.url,JSON.parse(b(new Uint8Array(n.body))))}const p=document.createElement("iframe"),_=window.location.protocol.replace(":","")+"://"+window.location.host;p.src=_+"/frontend/index.html";p.sandbox="allow-scripts";p.onload=()=>{console.info("iframe loaded")};document.body.appendChild(p);R(e=>{p.contentWindow.postMessage(e,_)});window.addEventListener("message",e=>{e.origin===_&&(console.log("Got message",e.data),W(e.data))});
//# sourceMappingURL=offlineframe-a2a08774.js.map
