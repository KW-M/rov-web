import{h as m,E as d,D as h}from"./consts-71a591af.js";const f=e=>({...e,bubbles:e.bubbles||!1,cancelBubble:e.cancelBubble||!1,cancelable:e.cancelable||!1,currentTarget:e.currentTarget||null,data:e.data,defaultPrevented:e.defaultPrevented||!1,eventPhase:e.eventPhase||0,lastEventId:e.lastEventId||"",origin:e.origin||"",path:e.path||new Array(0),ports:e.parts||new Array(0),returnValue:e.returnValue||!0,source:e.source||null,srcElement:e.srcElement||null,target:e.target||null,timeStamp:e.timeStamp||-1,type:e.type||"message",initMessageEvent:e.initMessageEvent||null,__proto__:e.__proto__}),s={triggerOnOpen:(e,r)=>{r=r||new Event("open",{composed:!1,bubbles:!1,cancelable:!1}),e._readyState=1,e._onopen&&e._onopen(r)},triggerOnError:(e,r)=>{r=r||new Event("error",{composed:!1,bubbles:!1,cancelable:!1}),e._readyState=3,e._onerror&&e._onerror(r)},triggerOnClose:(e,r)=>{r=r||new CloseEvent("close",{wasClean:!0,reason:"wsHook",composed:!1,bubbles:!1,cancelable:!1,code:1006}),e._readyState=3,e._onclose&&e._onclose(r)},triggerOnMessage:(e,r)=>{typeof r=="string"||r instanceof ArrayBuffer||(r=r.buffer),console.log("triggerOnMessage",r,e);const t=new MessageEvent("mesage",{data:r,origin:e.url,bubbles:!1,cancelable:!1,composed:!1});e._onmessage&&e._onmessage(t)},allowNewSocket:e=>!0,modifyUrl:e=>e,afterInit:e=>e,beforeOpen:(e,r,t)=>e,beforeError:(e,r,t)=>e,beforeClose:(e,r,t)=>e,beforeSend:(e,r,t)=>e,afterRecive:(e,r,t)=>e,resetHooks:()=>{}};(function(){const e=Object.assign({},s);s.resetHooks=function(){Object.assign(s,e)};var r=WebSocket;WebSocket=Object.assign(function(t,i){const y=s.allowNewSocket(t.toString());t=s.modifyUrl(t)||t;let n;y?(n=i?new r(t,i):new r(t),n.isReal=!0):(n=Object.assign({},r),Object.defineProperty(n,"url",{get(){return t}}),Object.defineProperty(n,"protocols",{get(){return i}}),Object.defineProperty(n,"readyState",{get(){return this._readyState}}),Object.defineProperty(n,"close",{value:()=>s.triggerOnClose(this)}),Object.defineProperty(n,"isReal",{value:!1}),Object.defineProperty(n,"_readyState",{value:0,writable:!0}));var _=n.send;return n.send=function(l){console.log("hook send"),arguments[0]=s.beforeSend(l,n.url,this)||null,arguments[0]!=null&&_.apply(this,arguments)},n._onopen=void 0,n._onerror=void 0,n._addEventListener=n.addEventListener||function(){},n.addEventListener=function(){var u;const l=this,o=arguments[0],a=arguments[1];return o==="message"?(n._onmessage=a,arguments[1]=function(g){return function(){arguments[0]=s.afterRecive(f(arguments[0]),n.url,n),arguments[0]!==null&&g.apply(l,arguments)}}(a)):o==="open"?(n._onopen=a,arguments[1]=function(g){return function(){arguments[0]=s.beforeOpen(arguments[0],n.url,n),arguments[0]!==null&&g.apply(l,arguments)}}(a)):o==="error"?(n._onerror=a,arguments[1]=function(g){return function(){arguments[0]=s.beforeError(arguments[0],n.url,n),arguments[0]!==null&&g.apply(l,arguments)}}(a)):o==="close"&&(n._onclose=a,arguments[1]=function(g){return function(){arguments[0]=s.beforeClose(arguments[0],n.url,n),arguments[0]!==null&&g.apply(l,arguments)}}(a)),(u=n._addEventListener)==null?void 0:u.apply(this,arguments)},Object.defineProperty(n,"onmessage",{set:function(){var u;var l=this,o=arguments[0];n._onmessage=o;var a=o?function(){n.isReal||console.log("onMessageHandler",arguments),arguments[0]=s.afterRecive(f(arguments[0]),n.url,n),arguments[0]!==null&&o.apply(l,arguments)}:null;console.log("onMsgHandler",arguments),(u=n._addEventListener)==null||u.apply(this,["message",a,!1])}}),Object.defineProperty(n,"onopen",{set:function(){var u;var l=this,o=arguments[0];n._onopen=o;var a=o?function(){n.isReal||console.log("onOpenHandler",arguments),arguments[0]=s.beforeOpen(arguments[0],n.url,n),arguments[0]!==null&&o.apply(l,arguments)}:null;console.log("onOpenHandler",arguments),(u=n._addEventListener)==null||u.apply(this,["open",a,!1])}}),Object.defineProperty(n,"onerror",{set:function(){var u;var l=this,o=arguments[0];n._onerror=o;var a=o?function(){n.isReal||console.log("onErrorHandler",arguments),arguments[0]=s.beforeError(arguments[0],n.url,n),arguments[0]!==null&&o.apply(l,arguments)}:null;(u=n._addEventListener)==null||u.apply(this,["error",a,!1])}}),Object.defineProperty(n,"onclose",{set:function(){var u;var l=this,o=arguments[0];n._onclose=o;var a=o?function(){n.isReal||console.log("onCloseHandler",arguments),arguments[0]=s.beforeClose(arguments[0],n.url,n),arguments[0]!==null&&o.apply(l,arguments)}:null;(u=n._addEventListener)==null||u.apply(this,["close",a,!1])}}),s.afterInit(n),n._readyState=r.OPEN,n},r)})();var E=(e=>(e[e.openWebsocket=0]="openWebsocket",e[e.socketMsg=1]="socketMsg",e[e.outgoingHttpReq=2]="outgoingHttpReq",e[e.incomingHttpReq=3]="incomingHttpReq",e))(E||{});let O=!0;const p={};let c=null;function k(e){c=e}const b=e=>e.startsWith(m)||!O;s.allowNewSocket=e=>(console.log("Checking ws url: ",e),b(e)?(console.log("Proxying ws url: ",e),!1):!0);s.modifyUrl=e=>(e=e.toString(),b(e)&&(e=e.substring(m.length)),console.log("modifyUrl: ",e),e);s.afterInit=e=>{const r=e.url;return e.isReal||(p[r]=e,setTimeout(()=>{s.triggerOnOpen(e),S(r)},1)),e};s.beforeSend=(e,r,t)=>t.isReal?e:(console.log("beforeSend: ",t.isReal,t.url,e),v(r,new Uint8Array(e)),null);function S(e){const r={type:0,url:e};console.log("Sending openWebsocket msg Thru Proxy",r),c&&c(d(JSON.stringify(r)))}function v(e,r){const t=new Uint8Array(r),i={type:1,url:e,body:new Array(...t)};console.log("Sending Data Thru Proxy",i),c&&c(d(JSON.stringify(i)))}function R(e){const r=JSON.parse(h(e));if(r.type===1){const t=p[r.url],i=new Uint8Array(r.body);console.log("Received Proxy Message",r,i),t&&s.triggerOnMessage(t,i)}}export{E as p,R as r,k as s};
//# sourceMappingURL=proxy-b9180d8c.js.map
