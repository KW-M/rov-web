import{i as b,E as m,D as y}from"./consts-b81d311f.js";const d=e=>({...e,bubbles:e.bubbles||!1,cancelBubble:e.cancelBubble||!1,cancelable:e.cancelable||!1,currentTarget:e.currentTarget||null,data:e.data,defaultPrevented:e.defaultPrevented||!1,eventPhase:e.eventPhase||0,lastEventId:e.lastEventId||"",origin:e.origin||"",path:e.path||new Array(0),ports:e.parts||new Array(0),returnValue:e.returnValue||!0,source:e.source||null,srcElement:e.srcElement||null,target:e.target||null,timeStamp:e.timeStamp||-1,type:e.type||"message",initMessageEvent:e.initMessageEvent||null,__proto__:e.__proto__}),l={triggerOnOpen:(e,r)=>{r=r||new Event("open",{composed:!1,bubbles:!1,cancelable:!1}),e._readyState=1,e._onopen&&e._onopen(r)},triggerOnError:(e,r)=>{r=r||new Event("error",{composed:!1,bubbles:!1,cancelable:!1}),e._readyState=3,e._onerror&&e._onerror(r)},triggerOnClose:(e,r)=>{r=r||new CloseEvent("close",{wasClean:!0,reason:"wsHook",composed:!1,bubbles:!1,cancelable:!1,code:1006}),e._readyState=3,e._onclose&&e._onclose(r)},triggerOnMessage:(e,r)=>{typeof r=="string"||r instanceof ArrayBuffer||(r=r.buffer),console.log("triggerOnMessage",r,e);const u=new MessageEvent("mesage",{data:r,origin:e.url,bubbles:!1,cancelable:!1,composed:!1});e._onmessage&&e._onmessage(u)},allowNewSocket:e=>!0,modifyUrl:e=>e,afterInit:e=>e,beforeOpen:(e,r,u)=>e,beforeError:(e,r,u)=>e,beforeClose:(e,r,u)=>e,beforeSend:(e,r,u)=>e,afterRecive:(e,r,u)=>e,resetHooks:()=>{}};let p=!1;function _(){if(p)return console.warn("hookWebsockets() can only be called once!"),l;p=!0;const e=Object.assign({},l);l.resetHooks=function(){Object.assign(l,e)};const r=WebSocket;return WebSocket=Object.assign(function(u,g){const f=l.allowNewSocket(u.toString());u=l.modifyUrl(u)||u;let n;f?(n=g?new r(u,g):new r(u),n.isReal=!0):(n=Object.assign({},r),Object.defineProperty(n,"url",{get(){return u}}),Object.defineProperty(n,"protocols",{get(){return g}}),Object.defineProperty(n,"readyState",{get(){return this._readyState}}),Object.defineProperty(n,"close",{value:()=>l.triggerOnClose(this)}),Object.defineProperty(n,"isReal",{value:!1}),Object.defineProperty(n,"_readyState",{value:0,writable:!0}));var o=n.send;return n.send=function(s){console.log("hook send"),arguments[0]=l.beforeSend(s,n.url,this)||null,arguments[0]!=null&&o.apply(this,arguments)},n._onopen=void 0,n._onerror=void 0,n._addEventListener=n.addEventListener||function(){},n.addEventListener=function(){var i;const s=this,t=arguments[0],a=arguments[1];return t==="message"?(n._onmessage=a,arguments[1]=function(c){return function(){arguments[0]=l.afterRecive(d(arguments[0]),n.url,n),arguments[0]!==null&&c.apply(s,arguments)}}(a)):t==="open"?(n._onopen=a,arguments[1]=function(c){return function(){arguments[0]=l.beforeOpen(arguments[0],n.url,n),arguments[0]!==null&&c.apply(s,arguments)}}(a)):t==="error"?(n._onerror=a,arguments[1]=function(c){return function(){arguments[0]=l.beforeError(arguments[0],n.url,n),arguments[0]!==null&&c.apply(s,arguments)}}(a)):t==="close"&&(n._onclose=a,arguments[1]=function(c){return function(){arguments[0]=l.beforeClose(arguments[0],n.url,n),arguments[0]!==null&&c.apply(s,arguments)}}(a)),(i=n._addEventListener)==null?void 0:i.apply(this,arguments)},Object.defineProperty(n,"onmessage",{set:function(){var i;var s=this,t=arguments[0];n._onmessage=t;var a=t?function(){n.isReal||console.log("onMessageHandler",arguments),arguments[0]=l.afterRecive(d(arguments[0]),n.url,n),arguments[0]!==null&&t.apply(s,arguments)}:null;console.log("onMsgHandler",arguments),(i=n._addEventListener)==null||i.apply(this,["message",a,!1])}}),Object.defineProperty(n,"onopen",{set:function(){var i;var s=this,t=arguments[0];n._onopen=t;var a=t?function(){n.isReal||console.log("onOpenHandler",arguments),arguments[0]=l.beforeOpen(arguments[0],n.url,n),arguments[0]!==null&&t.apply(s,arguments)}:null;console.log("onOpenHandler",arguments),(i=n._addEventListener)==null||i.apply(this,["open",a,!1])}}),Object.defineProperty(n,"onerror",{set:function(){var i;var s=this,t=arguments[0];n._onerror=t;var a=t?function(){n.isReal||console.log("onErrorHandler",arguments),arguments[0]=l.beforeError(arguments[0],n.url,n),arguments[0]!==null&&t.apply(s,arguments)}:null;(i=n._addEventListener)==null||i.apply(this,["error",a,!1])}}),Object.defineProperty(n,"onclose",{set:function(){var i;var s=this,t=arguments[0];n._onclose=t;var a=t?function(){n.isReal||console.log("onCloseHandler",arguments),arguments[0]=l.beforeClose(arguments[0],n.url,n),arguments[0]!==null&&t.apply(s,arguments)}:null;(i=n._addEventListener)==null||i.apply(this,["close",a,!1])}}),l.afterInit(n),n._readyState=r.OPEN,n},r),l}var h=(e=>(e[e.openWebsocket=0]="openWebsocket",e[e.socketMsg=1]="socketMsg",e[e.outgoingHttpReq=2]="outgoingHttpReq",e[e.incomingHttpReq=3]="incomingHttpReq",e))(h||{});function v(){if(!window.parent||window.parent===window)return console.warn("enableFrameProxy() called without this page being inside an iframe!");const e=E(r=>!0,r=>{window.parent.postMessage(r,"*")});window.addEventListener("message",r=>{console.log("Got iframe parent message",r),e(r.data)})}function E(e,r){const u={},g=_();g.allowNewSocket=o=>(console.log("Checking ws url: ",o),e(o)?(console.log("Proxying ws url: ",o),!1):!0),g.modifyUrl=o=>(o=o.toString(),e(o)&&(o=o.substring(b.length)),console.log("modifyUrl: ",o),o),g.afterInit=o=>{const s=o.url;return o.isReal||(u[s]=o,setTimeout(()=>{g.triggerOnOpen(o),f(s)},1)),o},g.beforeSend=(o,s,t)=>t.isReal?o:(console.log("beforeSend: ",t.isReal,t.url,o),n(s,new Uint8Array(o)),null);function f(o){const s={type:0,url:o};console.log("Sending openWebsocket msg Thru Proxy",s),r&&r(m(JSON.stringify(s)))}function n(o,s){const t=new Uint8Array(s),a={type:1,url:o,body:new Array(...t)};console.log("Sending Data Thru Proxy",a),r&&r(m(JSON.stringify(a)))}return function(s){const t=JSON.parse(y(s));if(t.type===1){const a=u[t.url],i=new Uint8Array(t.body);console.log("Received Proxy Message",t,i),a&&g.triggerOnMessage(a,i)}}}export{v as e,h as p};
//# sourceMappingURL=iframeWsProxy-d634e15c.js.map
