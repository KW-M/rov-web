var S=Object.defineProperty;var k=(n,e,t)=>e in n?S(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var s=(n,e,t)=>(k(n,typeof e!="symbol"?e+"":e,t),t);import{L as p,d as w,e as f,C as l,S as y}from"./consts-df80bb01.js";import{r as c,a as _,c as d,b as u,S as L,d as M}from"./simplePeer-479d5a97.js";class R{constructor(){s(this,"socket");s(this,"serverAddress");s(this,"msgReceivedFn");s(this,"isRunning");s(this,"isConnected");s(this,"connectionTimerId");this.isConnected=!1,this.isRunning=!1,this.connectionTimerId=0,this.serverAddress=""}start(e,t){this.serverAddress=e,this.msgReceivedFn=t,this.isRunning=!0,this.connect()}stop(){this.isRunning=!1,this.socket.close()}connect(){console.log("Attempting to connect to python websocket..."),this.socket=new WebSocket(this.serverAddress),this.socket.binaryType="blob",this.isConnected=!0,this.socket.addEventListener("close",e=>{console.log("WebSocket connection closed with code: ",e.code),this.isConnected=!1,this.isRunning&&this.queueConnect()}),this.socket.addEventListener("error",e=>{console.error("WebSocket error:",e),this.isConnected=!1,this.isRunning&&this.queueConnect()}),this.socket.addEventListener("message",e=>{e.data.arrayBuffer().then(t=>{this.msgReceivedFn(new Uint8Array(t))})})}queueConnect(){clearTimeout(this.connectionTimerId),this.connectionTimerId=setTimeout(this.connect.bind(this),2e3)}getIsConnected(){return this.isConnected}sendMessage(e){this.socket.send(e)}}const h=new R;function P(n,e){return e.SimplepeerSignal?(m.ingestSimplePeerSignallingMsg(n,e.SimplepeerSignal.Message),!0):!1}function C(n,e){let t=new Uint8Array(e);if(!t||t.length===0)return;const o=c.RovAction.decode(t);if(console.debug("Rcvd Msg: ",o.toJSON()),P(n,o))return;o.BackendMetadata=o.BackendMetadata||new c.ActionBackendMetadata,o.BackendMetadata.FromUserId=n;const i=c.RovAction.encode(o).finish();h.isConnected&&h.sendMessage(i)}const b=globalThis.livekitServerSDK.EgressClient,T=globalThis.livekitServerSDK.StreamProtocol;class E{constructor(){s(this,"_twitchStreamKey",null);s(this,"_egressClient",null);s(this,"roomName",null);s(this,"streamEgressID",null)}init(e,t,o,i){this._twitchStreamKey=e,this.roomName=t,this._egressClient=new b("https://rov-web.livekit.cloud",o,i)}async startStream(){if(!this._twitchStreamKey)return console.warn("startStream() err: Twitch stream key not set!");const e={protocol:T.RTMP,urls:["rtmp://live.twitch.tv/app/"+this._twitchStreamKey]};var t=await this._egressClient.startRoomCompositeEgress(this.roomName,e);this.streamEgressID=t.egressId}async stopStream(){if(!this.streamEgressID)return console.warn("stopStream() err: Twitch Stream not started!");await this._egressClient.stopEgress(this.streamEgressID)}}const g=new E;class A{constructor(){s(this,"_cloudLivekitConnection",new _);s(this,"_simplePeerConnections",{});s(this,"_cameraMediaStream",null);this._cloudLivekitConnection.init({hostUrl:p,publishVideo:!0,reconnectAttempts:300,roomConnectionConfig:w,roomConfig:f}),d(this._cloudLivekitConnection.latestRecivedDataMessage,e=>{if(!e)return;const{senderId:t,msg:o}=e;C(t,o)}),d(this._cloudLivekitConnection.connectionState,e=>{console.log("Cloud Conn State Changed: "+e),e==l.connected&&g.startStream()}),d(this._cloudLivekitConnection.participantConnectionEvents,e=>{console.log("Cloud Conn Participant Event: ",e)})}async cameraReady(e){this._cameraMediaStream=e,this._cloudLivekitConnection&&this._cloudLivekitConnection.connectionState.get()==l.connected&&this._cameraMediaStream&&await this._cloudLivekitConnection._roomConn.localParticipant.setCameraEnabled(!0)}async start(e){e.EnableLivekitCloud&&await u(this._cloudLivekitConnection.startRoom,this._cloudLivekitConnection,10,1e3,1.3)(e.RovName,e.LivekitAPIKey,e.LivekitSecretKey).catch(t=>{console.error(t),window.location.reload()}),u(navigator.mediaDevices.getUserMedia,navigator.mediaDevices,10,1e3,1.3)({video:!0,audio:!1}).then(this.cameraReady.bind(this)).catch(t=>{console.error(t),window.location.reload()}),console.info("Connection Manager Started")}async startSimplePeerConnection(e,t){this._simplePeerConnections[e]&&(this._simplePeerConnections[e].stop(),delete this._simplePeerConnections[e]);const o=new L;d(o.latestRecivedDataMessage,i=>{C(e,i)}),d(o.outgoingSignalingMessages,i=>{this.sendMessage({SimplepeerSignal:{Message:i}},!0,[e])}),await o.start({initiator:!1,trickle:!1,streams:[this._cameraMediaStream]}),this._simplePeerConnections[e]=o,t&&o.ingestSignalingMsg(t)}async ingestSimplePeerSignallingMsg(e,t){const o=this._simplePeerConnections[e];o?[l.failed,l.disconnectedOk,l.init].includes(o.connectionState.get())?await this.startSimplePeerConnection(e,t):o.ingestSignalingMsg(t):await this.startSimplePeerConnection(e,t)}async _sendMessageViaLivekit(e,t,o){await this._cloudLivekitConnection.sendMessage(e,t,o)}async sendMessage(e,t,o){console.info("Sending Message to ["+o.join(", ")+"]",t?"reliably":"unreliably",":",e),e.BackendMetadata=new c.ResponseBackendMetadata({});const i=c.RovResponse.encode(e).finish(),v=o;await this._cloudLivekitConnection.sendMessage(i,t,v)}}const m=new A;window.getLongTermStarterAccessToken=M;const r=new URLSearchParams(location.search),a={RovName:r.get("RovName"),RovControlPassword:r.get("RovControlPassword"),LivekitAPIKey:r.get("LivekitApiKey"),LivekitSecretKey:r.get("LivekitSecretKey"),TwitchStreamKey:r.get("TwitchStreamKey")||"None",EnableLivekitLocal:(r.get("ForceLocal")||"false").toLowerCase()==="true",EnableLivekitCloud:(r.get("EnableCloud")||"true").toLowerCase()==="true",PythonWebsocketPort:parseInt(r.get("PythonWebsocketPort"))||0,AuthTokenTimeout:parseInt(r.get("AuthTokenTimeout"))||y};for(const n in a)if(a[n]==null)throw new Error("Missing required url query parameter: "+n);m.start(a);a.TwitchStreamKey!=="None"&&(g.init(a.TwitchStreamKey,a.RovName,a.LivekitAPIKey,a.LivekitSecretKey),window.addEventListener("beforeunload",()=>g.stopStream()));const I=async()=>{try{const e=await(await fetch("http://localhost:5000/start_logging",{method:"POST"})).text();console.log(e)}catch(n){console.error(n)}},K=async()=>{try{const e=await(await fetch("http://localhost:5000/stop_logging",{method:"POST"})).text();console.log(e)}catch(n){console.error(n)}};a.PythonWebsocketPort!=0&&h.start("ws://localhost:"+a.PythonWebsocketPort,n=>{if(n.length===0)return;const e=c.RovResponse.decode(n);if(!e.BackendMetadata)return console.error("No BackendMetadata in message from iROV",e.toJSON(),n);const t=e.BackendMetadata.TargetUserIds,i=e.BackendMetadata.TransportMethod==c.DataTransportMethod.LivekitReliable;m.sendMessage(e,i,t),e.RovOnline&&I(),window.addEventListener("beforeunload",()=>K())});
//# sourceMappingURL=index-87577911.js.map
