var k=Object.defineProperty;var L=(o,e,n)=>e in o?k(o,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[e]=n;var i=(o,e,n)=>(L(o,typeof e!="symbol"?e+"":e,n),n);import{L as M,d as u,e as m,c as f}from"./consts-15a88850.js";import{r,a as v,c as a,b as d,S as R}from"./simplePeer-e3e20f8e.js";class _{constructor(){i(this,"socket");i(this,"serverAddress");i(this,"msgReceivedFn");i(this,"isRunning");i(this,"isConnected");i(this,"connectionTimerId");this.isConnected=!1,this.isRunning=!1,this.connectionTimerId=0,this.serverAddress="ws://localhost:8765/"}start(e){this.msgReceivedFn=e,this.isRunning=!0,this.connect()}stop(){this.isRunning=!1,this.socket.close()}connect(){console.log("Attempting to connect to python websocket..."),this.socket=new WebSocket(this.serverAddress),this.socket.binaryType="blob",this.isConnected=!0,this.socket.addEventListener("close",e=>{console.log("WebSocket connection closed with code: ",e.code),this.isConnected=!1,this.isRunning&&this.queueConnect()}),this.socket.addEventListener("error",e=>{console.error("WebSocket error:",e),this.isConnected=!1,this.isRunning&&this.queueConnect()}),this.socket.addEventListener("message",e=>{e.data.arrayBuffer().then(n=>{this.msgReceivedFn(new Uint8Array(n))})})}queueConnect(){clearTimeout(this.connectionTimerId),this.connectionTimerId=setTimeout(this.connect.bind(this),2e3)}getIsConnected(){return this.isConnected}sendMessage(e){this.socket.send(e)}}const C=new _;function p(o,e){return e.SimplepeerSignal?(h.ingestSimplePeerSignallingMsg(o,e.SimplepeerSignal.Message),!0):!1}function g(o,e){let n=new Uint8Array(e);if(!n||n.length===0)return;console.error("GOT DC DATA:",n,o);const t=r.RovAction.decode(n);if(p(o,t))return;t.BackendMetadata=t.BackendMetadata||new r.ActionBackendMetadata,t.BackendMetadata.FromUserId=o;const s=r.RovAction.encode(t).finish();C.isConnected&&C.sendMessage(s)}class S{constructor(){i(this,"_cloudLivekitConnection",new v);i(this,"_localLivekitConnection",new v);i(this,"_simplePeerConnections",{});i(this,"_cameraMediaStream",null);this._cloudLivekitConnection.init({hostUrl:M,publishVideo:!0,reconnectAttempts:300,roomConnectionConfig:u,roomConfig:m}),a(this._cloudLivekitConnection.latestRecivedDataMessage,e=>{if(!e)return;const{senderId:n,msg:t}=e;g(n,t)}),a(this._cloudLivekitConnection.connectionState,e=>{console.log("Cloud Conn State Changed: "+e)}),a(this._cloudLivekitConnection.participantConnectionEvents,e=>{console.log("Cloud Conn Participant Event: ",e)}),this._localLivekitConnection.init({hostUrl:f,publishVideo:!0,reconnectAttempts:300,roomConnectionConfig:u,roomConfig:m}),a(this._localLivekitConnection.latestRecivedDataMessage,e=>{if(!e)return;const{senderId:n,msg:t}=e;g(n,t)}),a(this._localLivekitConnection.connectionState,e=>{console.log("Local Conn State Changed: "+e)}),a(this._localLivekitConnection.participantConnectionEvents,e=>{console.log("Local Conn Participant Event: ",e)})}async start(e){e.EnableLivekitCloud&&await d(this._cloudLivekitConnection.startRoom,this._cloudLivekitConnection)(e.RovRoomName,e.CloudAPIKey,e.CloudSecretKey),e.EnableLivekitLocal&&await d(this._localLivekitConnection.startRoom,this._localLivekitConnection)(e.RovRoomName,e.CloudAPIKey,e.CloudSecretKey),this._cameraMediaStream=await d(navigator.mediaDevices.getUserMedia,navigator.mediaDevices)({video:!0,audio:!1}),console.log("ConnectionManager Started")}async startSimplePeerConnection(e,n){this._simplePeerConnections[e]&&(this._simplePeerConnections[e].stop(),delete this._simplePeerConnections[e]);const t=new R;a(t.latestRecivedDataMessage,s=>{g(e,s)}),a(t.outgoingSignalingMessages,s=>{this.sendMessage({SimplepeerSignal:{Message:s}},!0,[e])}),await t.start({initiator:!1,trickle:!1,streams:[this._cameraMediaStream]}),this._simplePeerConnections[e]=t,n&&t.ingestSignalingMsg(n)}async ingestSimplePeerSignallingMsg(e,n){}async _sendMessageViaLivekit(e,n,t){await this._cloudLivekitConnection.sendMessage(e,n,t),await this._localLivekitConnection.sendMessage(e,n,t)}async sendMessage(e,n,t){console.log("Sending WEBRTC Message to: ["+t.join(", ")+"] reliable: "+n,e);const s=r.RovResponse.encode(e).finish();await this._cloudLivekitConnection.sendMessage(s,n,t)}}const h=new S,c=new URLSearchParams(location.search),l={RovRoomName:c.get("RovRoomName"),CloudAPIKey:c.get("CloudAPIKey"),CloudSecretKey:c.get("CloudSecretKey"),LocalAPIKey:c.get("LocalAPIKey")||"N/A",LocalSecretKey:c.get("LocalSecretKey")||"N/A",EnableLivekitLocal:(c.get("ForceLocal")||"false").toLowerCase()==="true",EnableLivekitCloud:(c.get("EnableCloud")||"true").toLowerCase()==="true",EnableBackendWebsocket:(c.get("EnableBackendWebsocket")||"true").toLowerCase()==="true"};for(const o in l)if(l[o]==null)throw new Error("Missing some required livekit setup url query params.");h.start(l);l.EnableBackendWebsocket&&C.start(o=>{if(o.length===0)return;const e=r.RovResponse.decode(o);if(!e.BackendMetadata)return console.error("No BackendMetadata in message from iROV",e.toJSON(),o);const n=e.BackendMetadata.TargetUserIds,s=e.BackendMetadata.TransportMethod==r.DataTransportMethod.LivekitReliable;h.sendMessage(e,s,n)});
//# sourceMappingURL=index-47a89709.js.map
