{"version":3,"file":"offlineframe-081fd406.js","sources":["../../../frontend/src/js/shared/iframeWsProxy/iframeWsProxy.ts","../../../frontend/src/js/shared/iframeWsProxy/iframeWsProxyReceiver.ts","../../offlineframe/js/main.js"],"sourcesContent":["// https://stackoverflow.com/questions/61865890/run-websocket-in-web-worker-or-service-worker-javascript\n// https://github.com/skepticfx/wshook\n// https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Transferable_objects\n// Some Ideas\n\nimport { DECODE_TXT, ENCODE_TXT, PROXY_PREFIX } from \"../consts\";\nimport hookWebsockets from \"../libraries/websocketHook/wsHook\";\n\nexport enum proxyMessageTypes {\n    openWebsocket,\n    socketMsg,\n    outgoingHttpReq,\n    incomingHttpReq,\n}\n\nexport type proxyInterchangeFormat = {\n    type: proxyMessageTypes;\n    url: string;\n    body: number[]; // binary data\n    result: object; // for fetch response\n}\n\nexport function enableIframeWebsocketProxying() {\n    if (!window.parent || window.parent === window) return console.warn(\"enableFrameProxy() called without this page being inside an iframe!\")\n\n    // const origin = window.parent.location.protocol.replace(\":\", \"\") + \"://\" + window.parent.location.host;\n    const receiveProxiedMsg = startWebsocketProxying((url: string) => true, (data) => {\n        window.parent.postMessage(data, \"*\")\n    })\n    window.addEventListener('message', (msg) => {\n        // if (msg.origin === origin) { // security check\n        console.log(\"Got iframe parent message\", msg)\n        receiveProxiedMsg(msg.data)\n        // }\n    })\n}\n\nfunction startWebsocketProxying(isProxiedUrl: (url: string) => boolean, sendProxyMessageCallback: (data: ArrayBufferLike) => void) {\n    const proxiedWsObjects: { [key: string]: WebSocket } = {};\n\n    // Monkey Patch the native websocket object\n    const wsHook = hookWebsockets();\n\n    wsHook.allowNewSocket = (url) => {\n        console.log(\"Checking ws url: \", url)\n        if (isProxiedUrl(url)) {\n            console.log(\"Proxying ws url: \", url)\n            return false;\n        } else return true;\n    };\n\n    wsHook.modifyUrl = (url: string | URL) => {\n        url = url.toString();\n        if (isProxiedUrl(url)) url = url.substring(PROXY_PREFIX.length)\n        console.log(\"modifyUrl: \", url)\n        return url\n    };\n\n\n    wsHook.afterInit = (wsObject) => {\n        const url = wsObject.url;\n        if (!wsObject.isReal) {\n            proxiedWsObjects[url] = wsObject;\n            setTimeout(() => {\n                wsHook.triggerOnOpen(wsObject);\n                sendNewConnMsgThruProxy(url);\n            }, 1)\n        }\n        return wsObject;\n    };\n\n    wsHook.beforeSend = (data, url, wsObject) => {\n        if (wsObject.isReal) {\n            return data;\n        } else {\n            console.log(\"beforeSend: \", wsObject.isReal, wsObject.url, data)\n            sendDataThruProxy(url, new Uint8Array(data as ArrayBuffer))\n            return null\n        }\n    }\n\n    function sendNewConnMsgThruProxy(url: string) {\n        const proxiedMsg = {\n            type: proxyMessageTypes.openWebsocket,\n            url: url,\n        } as proxyInterchangeFormat\n        console.log(\"Sending openWebsocket msg Thru Proxy\", proxiedMsg)\n        if (sendProxyMessageCallback) sendProxyMessageCallback(ENCODE_TXT(JSON.stringify(proxiedMsg)))\n    }\n\n    function sendDataThruProxy(url: string, data: ArrayBufferLike) {\n        const binary = new Uint8Array(data)\n        const proxiedMsg = {\n            type: proxyMessageTypes.socketMsg,\n            url: url,\n            body: new Array(...binary)\n        } as proxyInterchangeFormat\n        console.log(\"Sending Data Thru Proxy\", proxiedMsg)\n        if (sendProxyMessageCallback) sendProxyMessageCallback(ENCODE_TXT(JSON.stringify(proxiedMsg)))\n    }\n\n    return function receiveProxiedMsg(rawMsg: ArrayBufferLike) {\n        const proxiedMsg = JSON.parse(DECODE_TXT(rawMsg)) as proxyInterchangeFormat;\n        if (proxiedMsg.type === proxyMessageTypes.socketMsg) {\n            const ws = proxiedWsObjects[proxiedMsg.url]\n            const body = new Uint8Array(proxiedMsg.body)\n            console.log(\"Received Proxy Message\", proxiedMsg, body)\n            if (ws) wsHook.triggerOnMessage(ws, body)\n        }\n    }\n}\n","import { type proxyInterchangeFormat, proxyMessageTypes } from \"./iframeWsProxy\";\nimport { DECODE_TXT, ENCODE_TXT } from \"../consts\";\n\nconst openHttpConnections: { [key: string]: Promise<Response> } = {}\nconst openWebsocketConnections: { [key: string]: WebSocket } = {}\n\nlet sendProxyMessageCallback: (rawMsg: ArrayBufferLike) => void;\nexport function setSendProxyMessageCallback(callback: (data: ArrayBufferLike) => void) {\n    sendProxyMessageCallback = callback;\n}\n\nfunction openWebsocket(url: string) {\n    if (openWebsocketConnections[url]) return openWebsocketConnections[url];\n    const ws = openWebsocketConnections[url] = new WebSocket(url);\n    ws.binaryType = \"arraybuffer\";\n    ws.addEventListener('message', (ev) => {\n        let data = typeof ev.data === typeof '' ? ENCODE_TXT(ev.data) : ev.data;\n        const binary = new Uint8Array(data)\n        if (sendProxyMessageCallback) sendProxyMessageCallback(ENCODE_TXT(JSON.stringify({\n            type: proxyMessageTypes.socketMsg,\n            body: new Array(...binary),\n            url: url,\n        } as proxyInterchangeFormat)))\n    })\n    ws.addEventListener('error', (ev) => {\n        console.warn('ws err ' + url, ev)\n    })\n    ws.addEventListener('close', (ev) => {\n        console.warn('ws close ' + url, ev)\n    })\n    return ws;\n}\n\nfunction sendWebsocketMsg(url: string, data: ArrayBufferLike) {\n    let ws = openWebsocketConnections[url];\n    if (!ws) ws = openWebsocket(url)\n    if (ws.readyState !== WebSocket.OPEN) {\n        console.log(\"osending\", DECODE_TXT(data), ws.readyState, WebSocket.OPEN)\n        ws.addEventListener('open', () => ws.send(data))\n    } else {\n        console.log(\"sending\")\n        ws.send(data);\n    }\n}\n\nfunction sendHttpRequest(url: string, fetchOptions: object) {\n    if (openHttpConnections[url] != undefined) return;\n    const f = openHttpConnections[url] = fetch(url, fetchOptions);\n    f.then(async (result) => {\n        console.log(\"fetch result\", result)\n        let body = new Uint8Array(await result.arrayBuffer())\n        if (sendProxyMessageCallback) sendProxyMessageCallback(ENCODE_TXT(JSON.stringify({\n            type: proxyMessageTypes.outgoingHttpReq,\n            result: result,\n            body: new Array(...body),\n            url: url,\n        } as proxyInterchangeFormat)))\n    }).catch((err) => {\n        console.log(\"fetch err\", err)\n    });\n}\n\nexport function receiveProxiedMsg(rawMsg: ArrayBufferLike) {\n    const proxiedMsg = JSON.parse(DECODE_TXT(rawMsg)) as proxyInterchangeFormat;\n    console.log(\"Received Proxy Message\", proxiedMsg)\n    if (proxiedMsg.type === proxyMessageTypes.openWebsocket) {\n        openWebsocket(proxiedMsg.url)\n    } else if (proxiedMsg.type === proxyMessageTypes.socketMsg) {\n        sendWebsocketMsg(proxiedMsg.url, new Uint8Array(proxiedMsg.body))\n    } else if (proxiedMsg.type === proxyMessageTypes.incomingHttpReq) {\n        sendHttpRequest(proxiedMsg.url, JSON.parse(DECODE_TXT(new Uint8Array(proxiedMsg.body))))\n    }\n}\n","import { receiveProxiedMsg, setSendProxyMessageCallback } from \"../../js/shared/iframeWsProxy/iframeWsProxyReceiver\";\nconst iframe = document.createElement('iframe');\nconst iframeHost = window.location.protocol.replace(\":\", \"\") + '://' + window.location.host;\n// const iframeHost = 'http://10.0.0.48:5173'\niframe.src = iframeHost + '/frontend/index.html'\niframe.setAttribute(\"sandbox\", \"allow-scripts\")\niframe.onload = () => {\n    console.info(\"iframe loaded\")\n}\ndocument.body.appendChild(iframe);\nsetSendProxyMessageCallback((data) => {\n    iframe.contentWindow.postMessage(data, iframeHost)\n})\nwindow.addEventListener('message', (msg) => {\n    if (msg.origin === iframeHost) {\n        console.log(\"Got message\", msg.data)\n        receiveProxiedMsg(msg.data)\n    }\n})\n"],"names":["DECODE_TXT","ENCODE_TXT","proxyMessageTypes","proxyMessageTypes2","openHttpConnections","openWebsocketConnections","sendProxyMessageCallback","setSendProxyMessageCallback","callback","openWebsocket","url","ws","ev","data","binary","sendWebsocketMsg","sendHttpRequest","fetchOptions","result","body","err","receiveProxiedMsg","rawMsg","proxiedMsg","iframe","iframeHost","msg"],"mappings":"AAQY,OAAA,KAAAA,EAAA,KAAAC,MAAA,uBAAA,IAAAC,GAAAA,IACRA,EAAAC,EAAA,cAAA,CAAA,EAAA,gBACAD,EAAAC,EAAA,UAAA,CAAA,EAAA,YACAD,EAAAC,EAAA,gBAAA,CAAA,EAAA,kBACAD,EAAAC,EAAA,gBAAA,CAAA,EAAA,kBAJQD,IAAAA,GAAA,CAAA,CAAA,ECLZ,MAAME,EAA4D,CAAA,EAC5DC,EAAyD,CAAA,EAE/D,IAAIC,EACG,SAASC,EAA4BC,EAA2C,CACxDF,EAAAE,CAC/B,CAEA,SAASC,EAAcC,EAAa,CAChC,GAAIL,EAAyBK,CAAG,EAAG,OAAOL,EAAyBK,CAAG,EACtE,MAAMC,EAAKN,EAAyBK,CAAG,EAAI,IAAI,UAAUA,CAAG,EAC5D,OAAAC,EAAG,WAAa,cACbA,EAAA,iBAAiB,UAAYC,GAAO,CAC/B,IAAAC,EAAO,OAAOD,EAAG,MAAS,SAAYX,EAAWW,EAAG,IAAI,EAAIA,EAAG,KAC7D,MAAAE,EAAS,IAAI,WAAWD,CAAI,EAC9BP,GAAmDA,EAAAL,EAAW,KAAK,UAAU,CAC7E,KAAMC,EAAkB,UACxB,KAAM,IAAI,MAAM,GAAGY,CAAM,EACzB,IAAAJ,CACuB,CAAA,CAAC,CAAC,CAAA,CAChC,EACEC,EAAA,iBAAiB,QAAUC,GAAO,CACzB,QAAA,KAAK,UAAYF,EAAKE,CAAE,CAAA,CACnC,EACED,EAAA,iBAAiB,QAAUC,GAAO,CACzB,QAAA,KAAK,YAAcF,EAAKE,CAAE,CAAA,CACrC,EACMD,CACX,CAEA,SAASI,EAAiBL,EAAaG,EAAuB,CACtD,IAAAF,EAAKN,EAAyBK,CAAG,EAChCC,IAAIA,EAAKF,EAAcC,CAAG,GAC3BC,EAAG,aAAe,UAAU,MACpB,QAAA,IAAI,WAAYX,EAAWa,CAAI,EAAGF,EAAG,WAAY,UAAU,IAAI,EACvEA,EAAG,iBAAiB,OAAQ,IAAMA,EAAG,KAAKE,CAAI,CAAC,IAE/C,QAAQ,IAAI,SAAS,EACrBF,EAAG,KAAKE,CAAI,EAEpB,CAEA,SAASG,EAAgBN,EAAaO,EAAsB,CACpD,GAAAb,EAAoBM,CAAG,GAAK,KAAW,QACjCN,EAAoBM,CAAG,EAAI,MAAMA,EAAKO,CAAY,GAC1D,KAAK,MAAOC,GAAW,CACb,QAAA,IAAI,eAAgBA,CAAM,EAClC,IAAIC,EAAO,IAAI,WAAW,MAAMD,EAAO,YAAa,CAAA,EAChDZ,GAAmDA,EAAAL,EAAW,KAAK,UAAU,CAC7E,KAAMC,EAAkB,gBACxB,OAAAgB,EACA,KAAM,IAAI,MAAM,GAAGC,CAAI,EACvB,IAAAT,CACuB,CAAA,CAAC,CAAC,CAAA,CAChC,EAAE,MAAOU,GAAQ,CACN,QAAA,IAAI,YAAaA,CAAG,CAAA,CAC/B,CACL,CAEO,SAASC,EAAkBC,EAAyB,CACvD,MAAMC,EAAa,KAAK,MAAMvB,EAAWsB,CAAM,CAAC,EACxC,QAAA,IAAI,yBAA0BC,CAAU,EAC5CA,EAAW,OAASrB,EAAkB,cACtCO,EAAcc,EAAW,GAAG,EACrBA,EAAW,OAASrB,EAAkB,UAC7Ca,EAAiBQ,EAAW,IAAK,IAAI,WAAWA,EAAW,IAAI,CAAC,EACzDA,EAAW,OAASrB,EAAkB,iBAC7Bc,EAAAO,EAAW,IAAK,KAAK,MAAMvB,EAAW,IAAI,WAAWuB,EAAW,IAAI,CAAC,CAAC,CAAC,CAE/F,CCvEA,MAAMC,EAAS,SAAS,cAAc,QAAQ,EACxCC,EAAa,OAAO,SAAS,SAAS,QAAQ,IAAK,EAAE,EAAI,MAAQ,OAAO,SAAS,KAEvFD,EAAO,IAAMC,EAAa,uBAC1BD,EAAO,aAAa,UAAW,eAAe,EAC9CA,EAAO,OAAS,IAAM,CAClB,QAAQ,KAAK,eAAe,CAChC,EACA,SAAS,KAAK,YAAYA,CAAM,EAChCjB,EAA6BM,GAAS,CAClCW,EAAO,cAAc,YAAYX,EAAMY,CAAU,CACrD,CAAC,EACD,OAAO,iBAAiB,UAAYC,GAAQ,CACpCA,EAAI,SAAWD,IACf,QAAQ,IAAI,cAAeC,EAAI,IAAI,EACnCL,EAAkBK,EAAI,IAAI,EAElC,CAAC"}